{% extends "layout.html" %}

{% block content %}
<script>
    $(document).ready(function() {
        $("#queryForm").submit(function(e) {
            e.preventDefault();
            $('#spinner').show();
            $('#doc_results').empty();
            $('#comp_results').empty();
            // e.stopPropagation(); 
            var query = $("#query").val();
            $.ajax('/query', {
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"query": query}),
                dataType: 'json',
                success: function(response) {
                    results = response.response.results;
                    console.log(results);
                    var documentCards = $();
                    var comprehensionCards = $();
                    results.forEach(function(item, i) {
                        var card = createCard(item, i);
                        documentCards = documentCards.add(card[0]);
                        comprehensionCards = comprehensionCards.add(card[1])
                    });
                    $('#spinner').hide();
                    $(function() {
                        $('#doc_results').append(documentCards);
                        $("#comp_results").append(comprehensionCards);
                        $("#comp_results").children().hide();
                        $('#doc_results').children().first().children().first().attr('id', "selectedcard");
                        $("#comp_results").children().first().show();

                    });
                },
                error: function(xhr, ajaxOptions, thrownError){
                    alert(xhr.responseText);
                    alert(thrownError);
                }
          });
      });

    function createCard(cardData, idx){
        var context = [];
        for (var i=0; i<cardData.comprehension.length; i++) {
            var highlighted_answer = "";
            var para = cardData.comprehension[i].context;
            var answer_start = cardData.comprehension[i].answer_start;
            var answer_end = cardData.comprehension[i].answer_end;
            var intial_part = para.substr(0, answer_start);
            var highlighted_part = para.substr(answer_start, answer_end - 1);
            var rest_part = para.substr(answer_end, para.length);
            highlighted_answer += intial_part;
            highlighted_answer += '<span style="background-color: #afdce3;">' + highlighted_part + '</span>',
            highlighted_answer += rest_part;
            console.log(cardData.comprehension[i].answer);
            console.log(para.substr(answer_start, answer_end-1));
            // context.push(cardData.paragraphs[para_id]);
            context.push(highlighted_answer);
        }

        var paragraphs_html = "";
        for (var i=0; i<context.length; i++) {
            paragraphs_html += context[i];
            paragraphs_html += '<div class="ui divider"></div>'
        }

        var content_html = "";
        for (var i=0; i<cardData.paragraphs.length; i++) {
            content_html += cardData.paragraphs[i];
            content_html += '<div class="space"></div>';
        }

        var title = "";
        if (cardData.title){
            title = cardData.title;
        } else {
            title = "Paper Link"
        }
        var documentRankCardTemplate = [
            '<div class="column space document" id="', idx.toString() ,'">',
                '<div class="ui raised card link doc">',
                    '<div class="content">',
                        '<div class="description">',
                            title.substr(0, 130),
                        '</div>',
                    '</div>',
                    '<div class="extra content">',
                        '<span>',
                            '<a class="abstract_modal" id="', idx.toString() ,'">Show Abstract</a>',
                        '</span>',
                        '<span class="right floated">',
                            '<a class="content_modal" id="', i.toString() ,'">Show Content</a>',
                        '</span>',
                    '</div>',
                    '<div class="extra content">',
                        '<a>Confidence:', cardData.document_score, '</a>',
                    '</div>',
                '</div>',
            '</div>'
        ];
        var comprehensionCardTemplate = [
            '<div class="column" id="comprehension_', idx.toString() ,'">',
                '<h4 class="ui blue segment top attached header">',
                '<a href="', cardData.url, '" target="_blank">', title, '</a></h4>',
                '<div class="ui bottom attached segment">',
                    '<div class="ui extra content top attached block header">',
                        '<div class="ui stackable three column divided grid container">',
                            '<div class="row">',
                                '<div class="column">',
                                    'Published Date:', cardData.publish_time,
                                '</div>',
                                '<div class="column">',
                                    'License:', cardData.license,
                                '</div>',
                                '<div class="column">',
                                    'Source:', cardData.source,
                                '</div>',
                            '</div>',
                            '<div class="row">',
                                '<div class="column">',
                                    'Authors:', cardData.authors,
                                '</div>',
                            '</div>',
                        '</div>',
                    '</div>',
                    '<div class="ui divider"></div>',
                    '<div class="description">',
                        paragraphs_html,
                    '</div>',
                    '<div class="extra content">',
                        '<span>',
                            '<a>Affiliations:', cardData.affiliations ,'</a>',
                        '</span>',
                    '</div>',
                '</div>',
            '</div>',
            '<div class="ui longer modal" id="abstract_', idx.toString() ,'">',
                '<div class="header">Abstract</div>',
                    '<div class="scrolling content">',
                    '<p>', cardData.abstract ,'</p>',
                '</div>',
            '</div>',
            '<div class="ui longer modal" id="content_', i.toString() ,'">',
                '<div class="header">Content</div>',
                    '<div class="scrolling content">',
                    '<p>', content_html ,'</p>',
                '</div>',
            '</div>'
        ];
        return [$(documentRankCardTemplate.join('')), $(comprehensionCardTemplate.join(''))];
    }

    });

    $(document).on("click", "a.abstract_modal", function(){
        var id = $(this).attr('id');
        $('#abstract_' + id).modal('show');
    });

    $(document).on("click", "a.content_modal", function(){
        var id = $(this).attr('id');
        $('#content_' + id).modal('show');
    });

    $(document).on("click", "a.context_modal", function(){
        var id = $(this).attr('id');
        $('#context_' + id).modal('show');
    });

    $(document).on("click", "div.column.document", function(){
        var id = $(this).attr('id');
        $("#comp_results").children().hide();
        $('#comprehension_' + id).show();
        $('div.ui.raised.card.link.doc').removeAttr('id');
        $(this).children().first().attr('id', "selectedcard");
    });
</script>

<div class="ui segments">
    <div class="ui segment">
        <form class="ui form" id="queryForm">
            <div class="field">
                <div class="ui icon input">
                    <input id="query" type="text" placeholder="Search...">
                    <i class="search icon"></i>
                  </div>
            </div>
        </form>
    </div>
</div>

<div class="ui center aligned header" id="spinner" style="display: none;">
    <div class="ui center aligned">
        <div class="ui icon input loading">
            <i class="search icon"></i>
        </div>
    </div>
</div>

<div class="ui grid">
   <div class="four wide column" id="doc_results">
        <!-- <div class="column">
            <div class="ui raised card link doc">
                <div class="content">
                  <div class="description">
                    0 Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                  </div>
                </div>
                <div class="extra content">
                    <span>
                        <a class="abstract_modal" id="1">Show Abstract</a>
                    </span>
                    <span class="right floated">
                        <a class="content_modal" id="1">Show Content</a>
                    </span>
                </div>
                <div class="extra content">
                    Confidence: <a>0.45</a>
                </div>
            </div>
        </div> -->
   </div>

   <div class="twelve wide column scrolling content" id="comp_results">
        <!-- <div class="column">
            <h4 class="ui blue segment top attached header"><a>Title</a></h4>
            <div class="ui bottom attached segment">
                <div class="ui extra content top attached block header">
                    <div class="ui stackable three column divided grid container">
                        <div class="row">
                            <div class="column">
                                Published Date:
                            </div>
                            <div class="column">
                                License:
                            </div>
                            <div class="column">
                                Source:
                            </div>
                        </div>
                        <div class="row">
                            <div class="column">
                                Authors:
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ui divider"></div>
                <div class="description">
                    Panel content
                </div>
                <div class="ui divider"></div>
                <div class="extra content">
                    <a>Affliations: </a>
                </div>
            </div>
        </div> -->
    </div>
</div>

{% endblock %}